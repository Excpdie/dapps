<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <!-- Left navbar links -->
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#"><i class="fas fa-bars"></i></a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="http://www.kaka996.com/" class="nav-link" target="_blank">开发者网站</a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="http://doc.kaka996.com/" class="nav-link" target="_blank">文档</a>
      </li>
    </ul>

    <!-- SEARCH FORM -->
    <!-- <form class="form-inline ml-3">
      <div class="input-group input-group-sm">
        <input class="form-control form-control-navbar" type="search" placeholder="Search" aria-label="Search">
        <div class="input-group-append">
          <button class="btn btn-navbar" type="submit">
            <i class="fas fa-search"></i>
          </button>
        </div>
      </div>
    </form> -->

    <!-- Right navbar links -->
    <ul class="navbar-nav ml-auto" id="nav_bar_list">
      <li class="nav-item dropdown">
        <a class="nav-link" data-toggle="dropdown" href="#">
          设置
        </a>
        <div id="menu_right" class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
          <span class="dropdown-item dropdown-header" data-toggle="modal" data-target="#modal-lg">修改密码</span>
          <div class="dropdown-divider"></div>
        </div>
      </li>
    </ul>
  </nav>
  <!-- /.navbar -->

  <!-- Main Sidebar Container -->
  <aside class="main-sidebar sidebar-light-primary elevation-4">
    <!-- Brand Logo -->
    <a href="#" class="brand-link">
      <img src="/public/dist/img/logo.png" alt="AdminLTE Logo" class="brand-image img-circle elevation-3"
           style="opacity: .8">
      <span class="brand-text font-weight-light">Dapps store</span>
    </a>

    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Sidebar user panel (optional) -->
      <div class="user-panel mt-3 pb-3 mb-3 d-flex">
          <div class="image">
            <img id="user_avatar" src="/public/dist/img/avatar-default.jpg" class="img-circle elevation-2" alt="User Image">
          </div>
          <div id="user_info" class="info">
            <a href="/html/v1/login">登录</a>
          </div>
      </div>

      <!-- Sidebar Menu -->
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
          <!-- Add icons to the links using the .nav-icon class
               with font-awesome or any other icon font library -->
          <li class="nav-item">
            <a href="/html/v1/store/quick"  <% if (navigation === 'quick') { %> class="nav-link active" <% } else { %> class="nav-link" <% } %> >
              <i class="nav-icon fas fa-cubes"></i>
              <p>
                快速使用
              </p>
            </a>
          </li>
          <li class="nav-item">
            <a href="/html/v1/store/list"  <% if (navigation === 'store') { %> class="nav-link active" <% } else { %> class="nav-link" <% } %> >
              <i class="nav-icon fas fa-tachometer-alt"></i>
              <p>
                商店
              </p>
            </a>
          </li>
          <li class="nav-item">
            <a href="/html/v1/store/myapp" <% if (navigation === 'my_app') { %> class="nav-link active" <% } else { %> class="nav-link" <% } %> >
              <i class="nav-icon fas fa-th"></i>
              <p>
                我的
              </p>
            </a>
          </li>
          <li class="nav-item">
            <a href="/html/v1/dev/index" <% if (navigation === 'dev_index') { %> class="nav-link active" <% } else { %> class="nav-link" <% } %> >
              <i class="nav-icon fas fa-archive"></i>
              <p>
                开发者模式
              </p>
            </a>
          </li>
          <li class="nav-item">
            <a href="/html/v1/store/chat" <% if (navigation === 'chat') { %> class="nav-link active" <% } else { %> class="nav-link" <% } %> >
              <i class="nav-icon fas fa-comments"></i>
              <p>
                讨论
              </p>
            </a>
          </li>
          <li class="nav-item">
            <a href="/html/v1/store/appupdate" <% if (navigation === 'appupdate') { %> class="nav-link active" <% } else { %> class="nav-link" <% } %> >
              <i class="nav-icon fas fa-upload"></i>
              <p>
                升级
              </p>
            </a>
          </li>
          <li class="nav-item">
            <a href="/html/v1/store/help" <% if (navigation === 'help') { %> class="nav-link active" <% } else { %> class="nav-link" <% } %> >
              <i class="nav-icon fas fa-question"></i>
              <p>
                帮助
              </p>
            </a>
          </li>
          <li class="nav-item">
            <a href="/html/v1/store/version" <% if (navigation === 'version') { %> class="nav-link active" <% } else { %> class="nav-link" <% } %> >
              <i class="nav-icon fas fa-cog"></i>
              <p id="sys_version">
                版本信息
              </p>
            </a>
          </li>
          <!-- <li class="nav-item">
            <a href="#" class="nav-link">
              <i class="nav-icon fas fa-th"></i>
              <p>
                开发者
              </p>
            </a>
          </li> -->
        </ul>
      </nav>
      <!-- /.sidebar-menu -->
    </div>
    <!-- /.sidebar -->
  </aside>

  <div class="modal fade" id="modal-lg">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">修改密码</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form class="form-horizontal">
                    <div class="card-body">
                        <div class="form-group row">
                            <label class="col-sm-2 col-form-label">原密码</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="before_pwd" placeholder="" value="">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-2 col-form-label">新密码</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="new_pwd" placeholder="" value="">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-2 col-form-label">确认密码</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="confirm_pwd" placeholder="" value="">
                            </div>
                        </div>
                    </div>
                    <!-- /.card-body -->
                    <div class="card-body">
                        <button type="button" class="btn btn-info" id="modify_pwd">修改</button>
                        <button type="button" class="btn btn-default float-right" data-dismiss="modal">取消</button>
                    </div>
                    <!-- /.card-footer -->
                </form>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
  </div>

  <script>
    $(document).ready(function(){

      // 用户信息
      var username=localStorage.getItem("username");
      if (username) {
        $("#user_avatar").attr("src","/public/dist/img/user2-160x160.jpg");
        var user_info_content = '<a href="#" class="d-block">' + username + '</a>';
        $("#user_info").html(user_info_content);
        var bar_logout_html = '<span id="logout" class="dropdown-item dropdown-header">退出</span><div class="dropdown-divider"></div>';
        $("#menu_right").append(bar_logout_html);
      } else {
        alert("请登录");
        var url = "/html/v1/login";
        window.location.href= url; 
        return;
      }

      // 检查是否有新的版本
      var url = "/api/v1/store/check_sys_version";
      $.get(url,function(result){
        var versionInfo = result.data;
        if (versionInfo.has_new_version === true) {
          $("#sys_version").text("发现新版本");
        }
      });

    });

    $(function(){
      $('#logout').click(function() {
        localStorage.removeItem('token');   
        localStorage.removeItem('username');
        localStorage.removeItem('user_info');
        var url = "/html/v1/login";
        window.location.href= url; 
      });
      $('#modify_pwd').click(function() {
        var username=localStorage.getItem("username");
        if (username) {
          var beforePwd = $('#before_pwd').val();
          var newPwd = $('#new_pwd').val();
          var confirmPwd = $('#confirm_pwd').val();
          var params = {
            username: username,
            before_pwd: beforePwd,
            new_pwd: newPwd,
            confirm_pwd: confirmPwd
          };
          $.post('/api/v1/admin/modify_pwd',params,function(result){      
            console.log('result:', result);
              if (result.code !== 0) {
                  alert(result.msg);
                  return;
              } else {
                var url = "/html/v1/store/quick";
                window.location.href= url;
              }
          });
        }
      });
    });

  </script>